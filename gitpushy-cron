#!/bin/bash

# include GitPushy common functions
source $(dirname $0)/gitpushy-common

# gitpushy environment
export PUSHY_REPO="$(gitpushy-repo-name)"
export PUSHY_BRANCH="$1"
export PUSHY_TRIGGER=""
export PUSHY_TRIGGERS=()

# gitpushy build directives
export PUSHY_DEPLOY_HOTSWAP="-$(date +%Y%m%d-%H%M%S)"
export PUSHY_DEPLOY_ARCHIVE="~/$PUSHY_REPO-$(date +%Y%m%d-%H%M%S)"
export PUSHY_DEPLOY_DIR=""
export PUSHY_STAGE_DIR="~/pushy-staging-$PUSHY_REPO-$PUSHY_BRANCH"
export PUSHY_BUILD_DIR="/tmp/pushy-build-$PUSHY_REPO-$PUSHY_BRANCH-$(date +%Y%m%d-%H%M%S)-$RANDOM"
export PUSHY_BUILD_KEEP=""

# numeric switches
export PUSHY_VERBOSE=0
export PUSHY_REMOTE=0
export PUSHY_STATUS=0

# remote server definition
export PUSHY_SERVER="$HOSTNAME"
export PUSHY_PORT=22
export PUSHY_USER="$(whoami)"

# remote server definition
export PUSHY_SERVER="$HOSTNAME"
export PUSHY_PORT=22
export PUSHY_USER="$(whoami)"

# remember current repo settings
local OLD_GIT_DIR="$GIT_DIR"
local OLD_PWD_DIR="$(pwd)"
local REPO_GIT="$(cd "$(git rev-parse --git-dir)"; pwd)"

# set GIT_DIR to PWD if not set
export GIT_DIR="$REPO_GIT"

# start GitPushy
gitpushy-trigger cron

# reset git orientation
if [ -n "$OLD_GIT_DIR" ]; then
    export GIT_DIR="$OLD_GIT_DIR"
else
    unset GIT_DIR
fi
